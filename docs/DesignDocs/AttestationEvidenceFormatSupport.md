Attestation Evidence Format Support
=====

One of the goal of OE SDK attestation design is to be TEE-agnostic. At the same time, OE SDK should enable a verifier application to verify evidences from different sources and TEEs, if the format is known to the verifier.

Motivation
----------

Current evidence verify API `oe_verify_evidence()` verifies the evidences generated by `oe_get_evidence()` and returns the claims contained in the evidence. Such evidence has a specific format including an `oe_attestation_header`.
As reported in issue #2999, attestation service has to verify evidences from different sources other than those generated by `oe_get_evidence()`. Such as evidence generated by legacy OE SDK API `oe_get_report()` and raw TEE evidence generation such as SGX quote generation mechanism. And like `oe_verify_evidence()` returns claims, attestation service is also required to return the supplemental information. To achieve that, a new verify API is needed to verify different evidence structures and return the required supplemental information.

Goals:
- Verifier can call OE SDK API to verify known evidence formats generated by either OE SDK API or other attesters.

User Experience
---------------

New parameter `format_id` will be added to `oe_verify_evidence` to verify various evidences other than the ones generated by `oe_get_evidence()`, such as a raw SGX quote. To verify an evidence generated by `oe_get_evidence()`, `format_id` should be `null`.

Scenario 1 - Verifier verifies a raw evidence (not generated by `oe_get_evidence()`) of known format id:

1. Call OE SDK public API to initialize verifier plugins.
2. Get the raw evidence and its format id from an attester, such as get a raw sgx quote from Intel SGX SDK.
3. Call the new API with the evidence and the format id to verify the evidence.

Scenario 2 - Verifier verifies an evidence generated by `oe_get_evidence()`:

1. Call OE SDK public API to initialize verifier plugins.
2. Call the new API to verify the evidence. The format id is not required because it is contained in the evidence buffer.

Scenario 1 is for users who provide their own evidence structures (like #2999, user hopes to verify a raw sgx quote).

Scenario 2 is for users use the existing OESDK everywhere. They can use oe_generate_evidence to generate an oe_evidence structure and verify it by oe_verify_evidence.

In scenario 2, users should pass a `null` format id so that new `oe_get_evidence()` avoids guessing the provided evidence is a raw evidence or an oe_evidence, and the cases that the provided format id is not consistent with the id contained in the oe_evidence buffer.
```
Attester				        Verifier
--------- 				        ----------
1. SGX Quote 				        a. oe_verify_evidence(SGX_P256_QUOTE, evidence, ...)
2. oe_get_report() 			        b. oe_verify_evidence(SGX_P256_REPORT, evidence, ...)
3. oe_get_evidence(SGX_P256) 	                c. oe_verify_evidence(null, evidence, ...)

Evidence 1 should be verified by calling function a.
Evidence 2 should be verified by calling function b.
Evidence 3 should be verified by calling function c, not a.
```


Specification
-------------

### New API
An extra parameter `format_id` is added to current function oe_verify_evidence().

```
oe_result_t oe_verify_evidence(
    const oe_uuid_t* format_id,
    const uint8_t* evidence_buffer,
    size_t evidence_buffer_size,
    const uint8_t* endorsements_buffer,
    size_t endorsements_buffer_size,
    const oe_policy_t* policies,
    size_t policies_size,
    oe_claim_t** claims,
    size_t* claims_length);
```
This API is used to verify both evidences whose format id is provided by verifier and who is generated by `oe_get_evidence()`. When actual format_id is provided, it decouples evidence format ID and raw evidence buffer. When format_id is `null`, the API acts the same as previous `oe_get_evidence()`. This new design will provide more flexibility.


### New Format ID
According to issue #2999 reported by attestation service, it has to support two new evidence formats: the raw evidence generated by SGX quote generation and `oe_get_report()`. Thus, two new id need to be defined for evidence generated by `oe_get_report()`.

```
#define OE_FORMAT_UUID_SGX_ECDSA_P256_QUOTE  { _uuid_ }
#define OE_FORMAT_UUID_SGX_ECDSA_P256_REPORT { _uuid_ }
```
Current `OE_FORMAT_UUID_SGX_ECDSA_P256` format id is still used to identify the SGX ECDSA-p256 evidence generated by `oe_get_evidence()`.


### Additional Claims
The raw evidences generated by SGX quote generation and `oe_get_report()` have no custom claims. So, a new `oe_claim` field is introduced to retrieve `sgx_report_data` field inside sgx_quote. Attestation service needs this field as a part of their validation process.

```
#define OE_CLAIM_SGX_REPORT_DATA "sgx_report_data"
```

Alternatives
----------
We can also develop APIs that convert a raw evidence to and from an oe_evidence.

### convert_to_evidence().
When verifier application receives a format id and a raw evidence (such as an sgx quote), `verifier.convert_to_evidence()` converts the raw evidence to an oe_evidence. Then current `oe_verify_evidence()` can verify the converted evidence.
#### Inputs:
- Evidence format ID
- Raw evidence buffer
- Raw evidence buffer size
#### Outputs:
- OE evidence buffer
- OE evidence buffer size

### convert_from_evidence().
The function converts an oe_evidence to a raw evidence for some verifier applications to handle evidence generated by `oe_get_evidence()`.
#### Inputs:
- OE evidence buffer
- OE evidence buffer size
#### Outputs:
- Evidence format ID
- Raw evidence buffer
- Raw evidence buffer size

The conversion itself needs extra memory allocation and copy.

Authors
-------
Qiucheng Wang (qiucwang@microsoft.com)

Yen Lee (yenlee@microsoft.com)
